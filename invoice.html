<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Krishna Automobiles - Invoice Generator</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        background-color: #1f1f1f;
        color: white;
      }
      .invoice-table th {
        background-color: #ff6f00;
        color: white;
      }
      .invoice-table td {
        background-color: #2c2c2c;
        color: white;
      }
      input[type="text"],
      input[type="number"] {
        text-transform: uppercase;
      }
      .form-control-edit {
        width: 80px;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="index.html"
          >Krishna Automobiles</a
        >
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">üè† Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="products.html">üì¶ Inventory</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="invoice.html">üßæ Invoice</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="history.html">üìú History</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-danger" href="#" onclick="logout()"
                >üö™ Logout</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-5">
      <h1 class="text-center mb-4">Invoice Generator</h1>

      <!-- Customer Information -->
      <div class="row mb-3">
        <div class="col-md-3">
          <input
            type="text"
            id="customerName"
            class="form-control"
            placeholder="Customer Name"
          />
        </div>
        <div class="col-md-3">
          <input
            type="text"
            id="vehicleNumber"
            class="form-control"
            placeholder="Vehicle Number (GJ01AB1234)"
          />
        </div>
        <div class="col-md-3">
          <input
            type="text"
            id="customerMobile"
            class="form-control"
            placeholder="Mobile Number"
          />
        </div>
        <div class="col-md-3">
          <select id="paymentStatus" class="form-control">
            <option value="Pending">Pending</option>
            <option value="Paid">Paid</option>
          </select>
        </div>
      </div>

      <!-- Add Product -->
      <div class="row mb-3">
        <div class="col-md-4">
          <input
            list="productOptions"
            id="productInput"
            class="form-control"
            placeholder="Product Name"
            oninput="autoFillPrice()"
          />
          <datalist id="productOptions"></datalist>
        </div>
        <div class="col-md-2">
          <input
            type="number"
            id="quantityInput"
            class="form-control"
            placeholder="Qty"
            min="1"
          />
        </div>
        <div class="col-md-2">
          <input
            type="number"
            id="priceInput"
            class="form-control"
            placeholder="Price"
            min="0"
          />
        </div>
        <div class="col-md-4">
          <button class="btn btn-success w-100" onclick="addToInvoice()">
            Add to Invoice
          </button>
        </div>
      </div>

      <!-- Invoice Table -->
      <table class="table table-bordered invoice-table text-center">
        <thead>
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="invoiceTable"></tbody>
      </table>

      <div class="text-end me-5">
        <h5 id="grandTotal">Grand Total: ‚Çπ0</h5>
      </div>

      <div class="text-center">
        <button class="btn btn-primary" onclick="downloadInvoice()">
          Download Invoice
        </button>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      let products = JSON.parse(localStorage.getItem("products")) || [];
      let invoiceItems = [];

      const loadProductOptions = () => {
        const dataList = document.getElementById("productOptions");
        dataList.innerHTML = "";
        products.forEach((p) => {
          if (p.stock > 0) {
            dataList.innerHTML += `<option value="${p.name}"></option>`;
          }
        });
      };

      const getProductByName = (name) =>
        products.find((p) => p.name.toLowerCase() === name.toLowerCase());

      const autoFillPrice = () => {
        const name = document.getElementById("productInput").value.trim();
        const product = getProductByName(name);
        document.getElementById("priceInput").value = product
          ? product.price
          : "";
      };

      const updateGrandTotal = () => {
        const grandTotal = invoiceItems.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
        document.getElementById(
          "grandTotal"
        ).innerText = `Grand Total: ‚Çπ${grandTotal}`;
      };

      const renderInvoice = () => {
        const table = document.getElementById("invoiceTable");
        table.innerHTML = "";
        invoiceItems.forEach((item, i) => {
          const total = item.price * item.quantity;
          table.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td><input type="number" class="form-control form-control-edit" value="${
            item.price
          }" min="0" onchange="updatePrice(${i}, this.value)"></td>
          <td>‚Çπ${total}</td>
        </tr>
      `;
        });
        updateGrandTotal();
      };

      const updatePrice = (index, newPrice) => {
        const parsed = parseFloat(newPrice);
        if (!isNaN(parsed) && parsed >= 0) {
          invoiceItems[index].price = parsed;
          renderInvoice();
        }
      };

      const addToInvoice = () => {
        const name = document.getElementById("productInput").value.trim();
        const quantity = parseInt(
          document.getElementById("quantityInput").value
        );
        let price = parseFloat(document.getElementById("priceInput").value);
        const product = getProductByName(name);

        if (!product || isNaN(quantity) || quantity < 1) {
          return alert("Please enter valid product and quantity.");
        }

        if (product.stock < quantity) {
          return alert("Insufficient stock.");
        }

        if (isNaN(price)) price = product.price || 0;

        product.stock -= quantity;
        localStorage.setItem("products", JSON.stringify(products));

        invoiceItems.push({ name: product.name, quantity, price });
        renderInvoice();
        loadProductOptions();

        if (product.stock <= 3) {
          alert(
            `‚ö†Ô∏è Low stock for ${product.name}. Only ${product.stock} left.`
          );
        }

        document.getElementById("productInput").value = "";
        document.getElementById("quantityInput").value = "";
        document.getElementById("priceInput").value = "";
      };

      const downloadInvoice = async () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = 210;
        let y = 20;

        const logo = await fetch("logo krishna1.JPG")
          .then((r) => r.blob())
          .then(
            (blob) =>
              new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
              })
          );

        doc.addImage(logo, "JPEG", 10, 10, 30, 30);
        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.text("KRISHNA AUTOMOBILE", 45, 15);
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("SHOP NO: F/3, BESIDES AMC OFFICE, RAMVADI", 45, 22);
        doc.text("MOBILE: 9924501871, 6358331681", 45, 27);
        doc.text("EMAIL: 56krishnaautomobile@gmail.com", 45, 32);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("INVOICE", pageWidth - 20, 20, { align: "right" });

        const date = new Date().toLocaleDateString();
        doc.setFontSize(10);
        doc.text(`Date: ${date}`, pageWidth - 20, 27, { align: "right" });

        y = 42;
        const customer = document
          .getElementById("customerName")
          .value.toUpperCase();
        const vehicle = document
          .getElementById("vehicleNumber")
          .value.toUpperCase();
        const mobile = document.getElementById("customerMobile").value;
        const status = document.getElementById("paymentStatus").value;

        doc.setFont("helvetica", "normal");
        doc.text(`NAME       : ${customer}`, 14, y);
        y += 6;
        doc.text(`VEHICLE NO : ${vehicle}`, 14, y);
        y += 6;
        doc.text(`MOBILE NO  : ${mobile}`, 14, y);
        y += 6;
        doc.text(`PAYMENT    : ${status}`, 14, y);
        y += 10;

        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.setFillColor(52, 73, 94);
        doc.setTextColor(255);
        doc.rect(10, y, 190, 10, "F");
        doc.text("Sr No.", 14, y + 7);
        doc.text("Product Name", 30, y + 7);
        doc.text("Qty", 95, y + 7);
        doc.text("MRP", 115, y + 7);
        doc.text("Amount", 150, y + 7);

        y += 12;
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0);

        let totalAmount = 0;
        invoiceItems.forEach((item, i) => {
          const amount = item.price * item.quantity;
          totalAmount += amount;
          doc.setFillColor(i % 2 === 0 ? 255 : 245);
          doc.rect(10, y - 4, 190, 8, "F");
          doc.text(`${i + 1}`, 14, y);
          doc.text(item.name.toUpperCase(), 30, y);
          doc.text(`${item.quantity}`, 95, y);
          doc.text(`‚Çπ${item.price}`, 115, y);
          doc.text(`‚Çπ${amount}`, 150, y);
          y += 8;
        });

        y += 6;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setFillColor(255, 255, 200);
        doc.rect(130, y - 6, 60, 10, "F");
        doc.setTextColor(0);
        doc.text(`Total Amount: ‚Çπ${totalAmount}`, 135, y);

        y += 16;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text("PAYMENT METHOD: CASH / ONLINE", 14, y);

        y += 20;
        doc.setFont("helvetica", "italic");
        doc.setTextColor(91, 155, 213);
        doc.setFontSize(12);
        doc.text(
          "Thank you for choosing Krishna Automobile!",
          pageWidth / 2,
          y,
          { align: "center" }
        );

        doc.save("invoice.pdf");

        // Save to history with payment status
        let history = JSON.parse(localStorage.getItem("invoiceHistory")) || [];
        history.push({
          customer,
          vehicle,
          mobile,
          status,
          date,
          items: invoiceItems,
          total: totalAmount,
        });
        localStorage.setItem("invoiceHistory", JSON.stringify(history));
      };

      loadProductOptions();
      renderInvoice();
    </script>

    <script src="session.js"></script>
    <script>
  function logout() {
    localStorage.removeItem("isLoggedIn");
    location.href = "login.html";
  }
</script>

  </body>
</html>
